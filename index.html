<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VPINHUB Tournament Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-black text-gray-900 font-sans">

  <header class="bg-orange-500 shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 flex justify-center">
      <h1 id="mainTitle" class="text-3xl md:text-4xl font-extrabold tracking-tight text-white">
        VPINHUB Tournament Helper
      </h1>
    </div>
  </header>

  <main class="container mx-auto px-4 md:px-6 py-8">
    <div id="searchContainer" class="mb-8 flex justify-center">
      <input id="searchInput" type="text"
             placeholder="Search by name, manufacturer, or theme..."
             class="w-full md:w-2/3 p-4 rounded-lg bg-white border border-gray-300 text-gray-800
                    focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" />
    </div>
    
    <div id="mainContent">
        <div class="flex flex-col items-center">
            <div id="results" class="w-full space-y-5"></div>
        </div>

        <div id="loader" class="text-center p-8 hidden text-orange-500 font-semibold animate-pulse">
            <p>Loading more tables...</p>
        </div>
    </div>

    <div id="focusedView" class="hidden"></div>

    <div id="qrContainer" class="mt-12 flex flex-col items-center justify-center hidden">
      <h3 class="text-2xl font-bold text-white mb-4">Tournament Link</h3>
      <div id="qrcode" class="p-4 bg-white rounded-lg shadow-lg"></div>
    </div>
  </main>

  <div id="modal" class="fixed inset-0 hidden bg-black/80 backdrop-blur-sm items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl border border-orange-400 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 relative">
        <button id="closeModal" class="absolute top-4 right-4 text-2xl text-orange-500 hover:text-red-500 transition">&times;</button>
        <div id="modalContent" class="text-gray-900"></div>
      </div>
    </div>
  </div>

<script>
let db = [];
let currentItems = [];
let currentPage = 1;
const ITEMS_PER_PAGE = 20;

const searchContainer = document.getElementById("searchContainer");
const mainContent = document.getElementById("mainContent");
const focusedViewContainer = document.getElementById("focusedView");
const mainTitle = document.getElementById("mainTitle");
const resultsContainer = document.getElementById("results");
const searchInput = document.getElementById("searchInput");
const modal = document.getElementById("modal");
const closeModalBtn = document.getElementById("closeModal");
const modalContent = document.getElementById("modalContent");
const loader = document.getElementById("loader");

// --- Data Loading ---
loader.innerText = "Loading database, please wait...";
loader.classList.remove('hidden');

fetch("https://raw.githubusercontent.com/VirtualPinballSpreadsheet/vps-db/main/db/vpsdb.json")
  .then(res => {
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    return res.json();
  })
  .then(data => {
    db = data;
    
    if (Array.isArray(db)) {
      db.sort((a, b) => new Date(b.updatedAt || b.createdAt || 0) - new Date(a.updatedAt || a.createdAt || 0));
    }
    
    const urlParams = new URLSearchParams(window.location.search);
    const tableIdFromUrl = urlParams.get('tableId');
    const releaseIdFromUrl = urlParams.get('releaseId');
    const romUrlFromUrl = urlParams.get('rom');
    const unlistedTableUrl = urlParams.get('unlistedtable');
    const authorFromUrl = urlParams.get('author');
    const tnotesFromUrl = urlParams.get('tnotes');
    const rnotesFromUrl = urlParams.get('rnotes');
    const tfeaturesFromUrl = urlParams.get('tfeatures');
    const rfeaturesFromUrl = urlParams.get('rfeatures');
    const hideFromUrl = urlParams.has('hide');
    const b2sUrlFromUrl = urlParams.get('b2s');
    const romAuthorFromUrl = urlParams.get('rauthor');
    const b2sAuthorFromUrl = urlParams.get('b2sauthor');
    const imgFromUrl = urlParams.get('img');  
    const isSwl = urlParams.has('swl');
    const isTtd = urlParams.has('ttd');
    const isVpc = urlParams.has('vpc');
    const isFx = urlParams.has('fx');  
    const isFx3 = urlParams.has('fx3');  
    const fxCode = urlParams.get('fxcode');  
    const fxHostFromUrl = urlParams.get('fxhost');
    const fxPasswordFromUrl = urlParams.get('fxpassword');
    const hasQrCode = urlParams.has('qrcode');
    const isFx24 = urlParams.has('fx24');
    const fxStart = urlParams.get('fxstart');
    const is90min = urlParams.has('90min');

    if (tableIdFromUrl && (releaseIdFromUrl || unlistedTableUrl)) {
        const item = db.find(i => i.id === tableIdFromUrl);
        if (item) {
            renderFocusedView(tableIdFromUrl, releaseIdFromUrl, romUrlFromUrl, unlistedTableUrl, isSwl, isTtd, isVpc, authorFromUrl, tnotesFromUrl, rnotesFromUrl, hideFromUrl, b2sUrlFromUrl, romAuthorFromUrl, b2sAuthorFromUrl, tfeaturesFromUrl, rfeaturesFromUrl, imgFromUrl, isFx, fxCode, isFx3, fxHostFromUrl, fxPasswordFromUrl, isFx24, fxStart, is90min);  
        } else {
            renderResults(db);
        }
    } else if (tableIdFromUrl) {
        renderResults(db);
        if (db.some(item => item.id === tableIdFromUrl)) {
            openModal(tableIdFromUrl);
        }
    } else {
        renderResults(db);
    }

    if (hasQrCode) {
        const qrContainer = document.getElementById('qrContainer');
        const qrCodeEl = document.getElementById('qrcode');
        
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('qrcode');
        const urlToEncode = currentUrl.toString();

        qrCodeEl.innerHTML = '';  
        new QRCode(qrCodeEl, {
            text: urlToEncode,
            width: 256,
            height: 256,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        qrContainer.classList.remove('hidden');
    }

  })
  .catch(err => {
    console.error("Error loading remote JSON", err);
    loader.innerHTML = `<p class="text-red-400">Failed to load database from GitHub.</p>`;
  });

// --- Helper Functions ---
function copyToClipboard(text, btnElement) {
    navigator.clipboard.writeText(text).then(() => {
        const originalText = btnElement.innerText;
        btnElement.innerText = 'Copied!';
        btnElement.disabled = true;
        setTimeout(() => { btnElement.innerText = originalText; btnElement.disabled = false; }, 2000);
    }).catch(err => { console.error('Failed to copy: ', err); alert('Failed to copy URL to clipboard.'); });
}

function calculateFx24Times(fxStartParam) {
    let startTime, endTime;
    let startString = "Invalid Start Time";
    const timeZone = 'America/New_York'; // Eastern Time

    try {
        const decodedStart = decodeURIComponent(fxStartParam);
        const startHour = parseInt(decodedStart, 10);

        if (!isNaN(startHour) && String(startHour) === decodedStart && startHour >= 0 && startHour <= 23) {
            const nowET = new Date(new Date().toLocaleString('en-US', { timeZone }));
            let startET = new Date(nowET);
            startET.setHours(startHour, 0, 0, 0);

            if (nowET.getTime() > startET.getTime()) {
                startET.setDate(startET.getDate() + 1);
            }
            
            startTime = startET;
            startString = startTime.toLocaleString('en-US', { 
                timeZone, 
                month: 'long', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit', 
                timeZoneName: 'short' 
            });
        
        } else {
            startTime = new Date(decodedStart);
            startString = startTime.toLocaleString();
        }

        endTime = new Date(startTime.getTime() + 24 * 60 * 60 * 1000);
        
        return { startTime, endTime, startString };

    } catch (e) {
        console.error("Error parsing fxstart time:", e);
        return { startTime: null, endTime: null, startString: "Invalid Start Time" };
    }
}


// --- View Rendering ---
function createTournamentCard(config) {
    // UPDATED: Now destructures 'customDate' from config
    const { title, rulesHtml, buttonsHtml, cutoffDay, cutoffHour, cutoffTimezone, customDate } = config;
    
    let dateRangeString = "";

    if (customDate) {
        // If a custom date is provided, use it directly
        dateRangeString = customDate;
    } else {
        // Otherwise, calculate the weekly range as before
        const nowTZ = new Date(new Date().toLocaleString('en-US', { timeZone: cutoffTimezone }));
        let endDate = new Date(nowTZ);
        endDate.setHours(cutoffHour, 0, 0, 0);
        const daysToAdd = (cutoffDay - nowTZ.getDay() + 7) % 7;
        endDate.setDate(endDate.getDate() + daysToAdd);
        if (daysToAdd === 0 && nowTZ.getHours() >= cutoffHour) {
            endDate.setDate(endDate.getDate() + 7);
        }
        let startDate = new Date(endDate);
        startDate.setDate(startDate.getDate() - 7);
        const dateOptions = { month: 'long', day: 'numeric' };
        const formattedStartDate = startDate.toLocaleDateString('en-US', dateOptions);
        const formattedEndDate = endDate.toLocaleDateString('en-US', dateOptions);
        dateRangeString = `${formattedStartDate} - ${formattedEndDate}`;
    }

    return `<div class="bg-yellow-50 rounded-xl p-5 flex flex-col gap-4 items-start border-2 border-yellow-400"><div class="flex-grow w-full"><h3 class="text-xl font-semibold text-gray-900">${title}</h3><p class="text-base text-gray-700 mt-1"><strong>Event Period:</strong> ${dateRangeString}</p><div class="mt-3"><h4 class="font-semibold mb-2 text-gray-800">Rules & Submission:</h4>${rulesHtml}</div>${buttonsHtml}</div></div>`;
}

function renderFocusedView(itemId, releaseId, romUrl = null, unlistedTableUrl = null, isSwl = false, isTtd = false, isVpc = false, author = null, tnotes = null, rnotes = null, hide = false, b2sUrl = null, romAuthor = null, b2sAuthor = null, tfeatures = null, rfeatures = null, imgUrl = null, isFx = false, fxCode = null, isFx3 = false, fxHost = null, fxPassword = null, isFx24 = false, fxStart = null, is90min = false) {
    mainTitle.classList.add('hidden');
    searchContainer.classList.add('hidden');
    mainContent.classList.add('hidden');

    const item = db.find(x => x.id === itemId);
    if (!item) return;

    let tournamentCardHtml = '';
    const isFxPlatform = isFx || isFx3 || isFx24;  

    if (isSwl) {
        const rules = `<ul class="list-disc list-inside space-y-1.5 text-sm text-gray-700"><li>All scores must be submitted via <strong>iScored</strong>.</li><li>Manual submissions to iScored require a <strong>photo for verification</strong>.</li><li>VPinStudio auto-submissions are permitted, but players are responsible for <strong>verifying their score has posted</strong>.</li><li>No table or script modifications that affect gameplay are allowed.</li><li>The player with the highest valid score at the end of the event period wins.</li><li>The submission deadline is <strong>Sunday at 2:00 PM Eastern Time</strong>.</li></ul>`;
        const buttons = (url) => `<div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-3 items-center"><a href="${url}" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors shadow-sm">Submit Score</a><button onclick="copyToClipboard('${url}', this)" class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">VPinStudio iScored Link</button></div>`;
        const iscoredUrl = "https://www.iScored.info/VPINHUB";
        const config = { title: "VPINHUB Special When Lit", cutoffDay: 0, cutoffHour: 14, cutoffTimezone: 'America/New_York', rulesHtml: rules, buttonsHtml: buttons(iscoredUrl) };
        tournamentCardHtml = createTournamentCard(config);
    } else if (is90min) {
        // --- 90 MINUTE TOURNAMENT MODE ---
        const rules = `<ul class="list-disc list-inside space-y-1.5 text-sm text-gray-700"><li>All scores must be submitted via <strong>iScored</strong>.</li><li>Manual submissions to iScored require a <strong>photo for verification</strong>.</li><li>VPinStudio auto-submissions are permitted, but players are responsible for <strong>verifying their score has posted</strong>.</li><li>No table or script modifications that affect gameplay are allowed.</li><li>The player with the highest valid score at the end of the 90 minute period wins.</li></ul>`;
        
        const submitUrl = "https://www.iScored.info?mode=public&user=PaladinArcade";
        const vpinStudioUrl = "https://www.iScored.info/PaladinArcade";

        const buttons = `<div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-3 items-center"><a href="${submitUrl}" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors shadow-sm">Submit Score</a><button onclick="copyToClipboard('${vpinStudioUrl}', this)" class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">VPinStudio iScored Link</button></div>`;
        
        // Calculate Today's date dynamically
        const todayDate = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // Pass 'customDate' to override the weekly logic
        const config = { 
            title: "90 Min Visual Pinball Tournament", 
            customDate: todayDate,
            rulesHtml: rules, 
            buttonsHtml: buttons 
        };
        tournamentCardHtml = createTournamentCard(config);

    } else if (isTtd) {
        const rules = `<ul class="list-disc list-inside space-y-1.5 text-sm text-gray-700"><li>All scores must be submitted via <strong>iScored</strong>.</li><li>Manual submissions to iScored require a <strong>photo for verification</strong>.</li><li>VPinStudio auto-submissions are permitted, but players are responsible for <strong>verifying their score has posted</strong>.</li><li>No table or script modifications that affect gameplay are allowed.</li><li>The player with the highest valid score at the end of the event period wins.</li><li>The submission deadline is <strong>Thursday at 2:00 PM Eastern Time</strong>.</li></ul>`;
        const buttons = (url) => `<div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-3 items-center"><a href="${url}" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors shadow-sm">Submit Score</a><button onclick="copyToClipboard('${url}', this)" class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">VPinStudio iScored Link</button></div>`;
        const iscoredUrl = "https://www.iScored.info/SMAUG";
        const config = { title: "VPINHUB Thursday Throw Down", cutoffDay: 4, cutoffHour: 14, cutoffTimezone: 'America/New_York', rulesHtml: rules, buttonsHtml: buttons(iscoredUrl) };
        tournamentCardHtml = createTournamentCard(config);
    } else if (isVpc) {
        const rules = `<ul class="list-disc list-inside space-y-1.5 text-sm text-gray-700"><li>Scores must be submitted in the <strong>VPC Discord</strong>.</li><li>Look at the pinned post in the competition channel for the current table link.</li><li>You MUST use the specified table and version.</li><li>Players are required to include a <strong>photo with score submission</strong>.</li><li>No table or script modifications that affect gameplay are allowed.</li><li>The number of balls per game MUST NOT be modified.</li><li>Only <strong>single-player</strong> games are allowed.</li><li>The submission deadline is <strong>Monday at 12:00 AM PST</strong>.</li><li>To post a score, you MUST use the <strong>!score</strong> command in Discord.</li></ul>`;
        const buttons = `<div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-3 items-center"><a href="https://discord.com/invite/virtual-pinball-chat-652274650524418078" target="_blank" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors shadow-sm">Join VPC Discord</a></div>`;
        const config = { title: "Virtual Pinball Chat Competition Corner", cutoffDay: 1, cutoffHour: 0, cutoffTimezone: 'America/Los_Angeles', rulesHtml: rules, buttonsHtml: buttons };
        tournamentCardHtml = createTournamentCard(config);
    
    } else if (isFxPlatform) {
        
        const platformName = (isFx3) ? "Pinball FX3" : "Pinball FX";
        let rulesList = '';
        let codeHtml = '';

        if (fxHost) {
            const decodedHost = decodeURIComponent(fxHost.replace(/_/g, ' '));
            rulesList += `<li><strong>Table Host:</strong> ${decodedHost}</li>`;
        }
        if (fxPassword) {
            const decodedPassword = decodeURIComponent(fxPassword.replace(/_/g, ' '));
            rulesList += `<li><strong>Tournament Password:</strong> ${decodedPassword}</li>`;
        }
        
        if (fxCode) {
            const decodedCode = decodeURIComponent(fxCode.replace(/_/g, ' '));
            codeHtml = `<div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-3 items-center">
                <div>
                    <span class="text-sm font-semibold text-gray-800">${platformName} Tournament Code:</span>
                    <span class="ml-2 inline-block bg-gray-200 text-gray-900 font-mono text-sm px-3 py-1 rounded">${decodedCode}</span>
                </div>
                <button onclick="copyToClipboard('${decodedCode}', this)" class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-bold text-sm px-4 py-2 rounded-lg transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">Copy Code</button>
            </div>`;
        }


        if (isFx24 && fxStart) {
            const { startTime, startString } = calculateFx24Times(fxStart);
            const cardTitle = `VPINHUB 24-Hour ${platformName} Tournament`;
            
            const rules = `<ul class="list-disc list-inside space-y-1.5 text-sm text-gray-700">
                <li>High score at the end of the 24-hour period wins.</li>
                <li>This tournament is for <strong>${platformName}</strong>.</li>
                <li><strong>Starts:</strong> ${startString}</li>
                ${rulesList}
            </ul>`;

            tournamentCardHtml = `<div class="bg-blue-50 rounded-xl p-5 flex flex-col gap-4 items-start border-2 border-blue-400">
                <div class="flex-grow w-full">
                    <h3 class="text-xl font-semibold text-gray-900">${cardTitle}</h3>
                    ${(startTime ? '' : `<p class="text-red-500 font-bold p-4 bg-red-100 rounded">Error: ${startString}. Please check the 'fxstart' parameter.</p>`)}
                    <div class="mt-3">
                        <h4 class="font-semibold mb-2 text-gray-800">Details:</h4>
                        ${rules}
                    </div>
                    ${codeHtml}
                </div>
            </div>`;
            
        } else {
            const cardTitle = isFx3 ? "VPINHUB Pinball FX3 Tournament" : "VPINHUB Pinball FX Tournament";  

            let rules = `<ul class="list-disc list-inside space-y-1.5 text-sm text-gray-700">
                <li>High score at the end of the 1-hour tournament period wins.</li>
                <li>This tournament is for <strong>${platformName}</strong>.</li>
                ${rulesList}
            </ul>`;  
            
            tournamentCardHtml = `<div class="bg-blue-50 rounded-xl p-5 flex flex-col gap-4 items-start border-2 border-blue-400">
                <div class="flex-grow w-full">
                    <h3 class="text-xl font-semibold text-gray-900">${cardTitle}</h3>
                    <div class="mt-3">
                        <h4 class="font-semibold mb-2 text-gray-800">Rules:</h4>
                        ${rules}
                    </div>
                    ${codeHtml}
                </div>
            </div>`;
        }
    }

    let tournamentNotesHtml = '';
    if (tnotes) {
        const noteText = decodeURIComponent(tnotes.replace(/_/g, ' '));
        tournamentNotesHtml = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 my-4 rounded" role="alert"><p class="font-bold">Important Note</p><p>${noteText}</p></div>`;
    }

    let tableLabel = "Visual Pinball Table";
    if (unlistedTableUrl) {
        tableLabel = "Tournament Table";  
    }
    if (isFxPlatform) {
        tableLabel = "Tournament Pinball Table";  
    }

    let focusedTableHtml = '';
    if (unlistedTableUrl) {
        const fakeTableFile = { urls: [{ url: unlistedTableUrl }] };
        if (author && author.trim() !== '') {
            fakeTableFile.authors = [author.trim()];
        }
        if (tfeatures) {
            fakeTableFile.features = decodeURIComponent(tfeatures.replace(/_/g, ' ')).split(',');
        }
        focusedTableHtml = renderFile(fakeTableFile, tableLabel, item.id, true, isFxPlatform);
    } else {
        const focusedTableFile = (item.tableFiles || []).find(f => f.id === releaseId);
        if (focusedTableFile) {
            focusedTableHtml = renderFile(focusedTableFile, tableLabel, item.id, true, isFxPlatform);
        }
    }
    
    
    let dynamicRomHtml = '';
    let existingRomFilesHtml = '';

    if (!isFxPlatform) {  
        if (romUrl) {
            const fakeRomFile = { urls: [{ url: romUrl }] };
            if (rnotes) {
                fakeRomFile.comment = decodeURIComponent(rnotes.replace(/_/g, ' '));
            }
            if (romAuthor) {
                fakeRomFile.authors = [decodeURIComponent(romAuthor.replace(/_/g, ' '))];
            }
            if (rfeatures) {
                fakeRomFile.features = decodeURIComponent(rfeatures.replace(/_/g, ' ')).split(',');
            }
            dynamicRomHtml = renderFile(fakeRomFile, "Tournament Table Rom", null, true);
        }
        
        existingRomFilesHtml = (item.romFiles || []).map(f => renderFile(f, "ROM", null, true)).join("");
    }

    let dynamicB2sHtml = '';
    if (b2sUrl) {
        const fakeB2sFile = { urls: [{ url: b2sUrl }] };
        let authorName = '';
        if (b2sAuthor) {
            authorName = decodeURIComponent(b2sAuthor.replace(/_/g, ' '));
            fakeB2sFile.authors = [authorName];
        }

        if (!isFxPlatform || (isFxPlatform && authorName.toLowerCase() === 'ddh69')) {
             dynamicB2sHtml = renderFile(fakeB2sFile, "Tournament B2S", null, true);
        }
    }

    let tutorialDocsHtml = (item.tutorialFiles || []).map(f => renderFile(f, "Tutorial Document", null, true)).join("");

    let otherFilesHtml = '';
    if (!hide) {
        if (!isFxPlatform) {
            otherFilesHtml = [
                ...(item.b2sFiles || []).map(f => renderFile(f, "B2S Backglass", null, true)),
                ...(item.povFiles || []).map(f => renderFile(f, "POV File", null, true)),
                ...(item.wheelArtFiles || []).map(f => renderFile(f, "Wheel Art", null, true)),
                ...(item.pupPackFiles || []).map(f => renderFile(f, "PUP-Pack", null, true)),
                ...(item.altColorFiles || []).map(f => renderFile(f, "ALT Color", null, true)),
                ...(item.altSoundFiles || []).map(f => renderFile(f, "ALT Sound", null, true)),
                ...(item.tutorialVideoFiles || []).map(f => renderFile(f, "Tutorial Video", null, true))
            ].join("");
        } else {
            otherFilesHtml = (item.b2sFiles || [])
                .filter(f => (f.authors || []).some(a => a.toLowerCase() === 'ddh69'))
                .map(f => renderFile(f, "B2S Backglass", null, true))
                .join("");
        }
    }
    
    const filesHtml = tournamentCardHtml + tournamentNotesHtml + focusedTableHtml + dynamicRomHtml + dynamicB2sHtml + existingRomFilesHtml + otherFilesHtml + tutorialDocsHtml;

    const previewImgUrl = imgUrl || item.b2sFiles?.[0]?.imgUrl || item.tableFiles?.[0]?.imgUrl;
    let previewImageHtml = '';
    if (previewImgUrl) {
        previewImageHtml = `<div class="w-full flex justify-center mb-4"><img src="${previewImgUrl}" alt="Preview for ${item.name}" class="rounded-lg max-h-[50vh] max-w-full object-contain border-2 border-orange-400"/></div>`;
    }

    const focusedContent = `<div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl border border-orange-400 p-6 md:p-8"><h2 class="text-4xl font-bold mb-1 text-gray-900">${item.name}</h2><p class="text-lg text-gray-600 mb-4">${item.manufacturer || ""} • ${item.year || ""}</p>${previewImageHtml}<p class="mb-4 text-gray-800"><strong>Theme:</strong> ${(item.theme || []).join(", ") || "N/A"}</p><hr class="border-gray-200 my-4"><div class="space-y-4">${filesHtml}</div></div>`;

    focusedViewContainer.innerHTML = focusedContent;
    focusedViewContainer.classList.remove('hidden');
}

function renderCard(item) {
    const img = item.b2sFiles?.[0]?.imgUrl || item.tableFiles?.[0]?.imgUrl || "https://via.placeholder.com/300x200?text=No+Image";
    const authors = item.tableFiles?.[0]?.authors?.join(", ") || "Unknown";
    const type = item.type || "NA";
    const players = item.players || "N/A";
    return `<a href="?tableId=${item.id}" class="bg-white rounded-xl shadow-lg hover:shadow-orange-500/20 border border-gray-200 transition cursor-pointer flex p-4 gap-4" data-id="${item.id}"><img src="${img}" class="w-24 h-24 md:w-32 md:h-32 object-cover rounded-md bg-gray-100 flex-shrink-0 self-start" alt="Image for ${item.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/300x200?text=No+Image';"/><div class="overflow-hidden flex-grow"><h2 class="text-xl font-bold text-gray-900 truncate">${item.name}</h2><p class="text-sm text-gray-600">${item.manufacturer || "N/A"} • ${item.year || "N/A"}</p><p class="text-sm mt-1 text-gray-700 truncate">Authors: ${authors}</p><p class="text-xs mt-2 pt-2 border-t border-gray-200 text-gray-500">Type: <strong class="font-semibold text-gray-700">${type}</strong> &nbsp;|&nbsp; Players: <strong class="font-semibold text-gray-700">${players}</strong></p></div></a>`;
}

function loadMoreItems() {
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const paginatedItems = currentItems.slice(start, end);
    const html = paginatedItems.map(renderCard).join("");
    resultsContainer.insertAdjacentHTML('beforeend', html);
    currentPage++;
    if (end >= currentItems.length) { loader.classList.add('hidden'); } 
    else { loader.classList.remove('hidden'); loader.innerText = "Loading more tables..."; }
}

function renderResults(items) {
    resultsContainer.innerHTML = "";
    currentItems = items;
    currentPage = 1;
    if (items.length === 0) { loader.classList.remove('hidden'); loader.innerText = "No tables found matching your search."; return; }
    loadMoreItems();
}

const observer = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting) { loadMoreItems(); }
}, { rootMargin: "200px" });
observer.observe(loader);

function openModal(id) {
  const item = db.find(x => x.id === id);
  if (!item) return;
  const files = [
    ...(item.tableFiles || []).map(f => renderFile(f, "Visual Pinball Table", item.id, false, false)),
    ...(item.b2sFiles || []).map(f => renderFile(f, "B2S Backglass", null, false, false)),
    ...(item.povFiles || []).map(f => renderFile(f, "POV File", null, false, false)),
    ...(item.wheelArtFiles || []).map(f => renderFile(f, "Wheel Art", null, false, false)),
    ...(item.romFiles || []).map(f => renderFile(f, "ROM", null, false, false)),
    ...(item.pupPackFiles || []).map(f => renderFile(f, "PUP-Pack", null, false, false)),
    ...(item.altColorFiles || []).map(f => renderFile(f, "ALT Color", null, false, false)),
    ...(item.altSoundFiles || []).map(f => renderFile(f, "ALT Sound", null, false, false)),
    ...(item.tutorialVideoFiles || []).map(f => renderFile(f, "Tutorial Video", null, false, false)),
    ...(item.tutorialFiles || []).map(f => renderFile(f, "Tutorial Document", null, false, false))
  ].join("");
  const previewImgUrl = item.b2sFiles?.[0]?.imgUrl || item.tableFiles?.[0]?.imgUrl;
  let previewImageHtml = '';
  if (previewImgUrl) { previewImageHtml = `<img src="${previewImgUrl}" alt="Preview for ${item.name}" class="w-full rounded-lg mb-4 max-h-96 object-contain bg-gray-100"/>`; }
  const content = `<h2 class="text-2xl font-bold mb-1">${item.name}</h2><p class="text-gray-600 mb-4">${item.manufacturer || ""} • ${item.year || ""}</p>${previewImageHtml}<p class="mb-4"><strong>Theme:</strong> ${(item.theme || []).join(", ") || "N/A"}</p><hr class="border-gray-200 my-4"><div class="space-y-4">${files || "No files listed for this entry."}</div>`;
  modalContent.innerHTML = content;
  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

function renderFile(file, label, gameId, isFocusedView = false, isFxPlatform = false) {
  if (!file) return "";
  if (label === 'Tutorial Document' && !file.url && (!file.urls || file.urls.length === 0)) { return ""; }

  let imageHtml = '';
  if (file.imgUrl) { imageHtml = `<div class="flex-shrink-0"><img src="${file.imgUrl}" alt="Image for ${label}" class="w-32 h-32 sm:w-40 sm:h-40 object-cover rounded-md border-2 border-orange-400 bg-gray-200"/></div>`; }
  
  let urlObjects = [];
  if (file.urls) { urlObjects = file.urls; } 
  else if (file.url) { urlObjects = [{ url: file.url }]; }
  
  const buttonText = label.includes('Tutorial') ? 'View Tutorial' : 'Download';
  
  let urlsHtml;
  if (isFxPlatform && (label === 'Tournament Pinball Table' || label === 'Tournament Table')) {
      urlsHtml = '<span class="text-xs text-gray-500">This is a Pinball FX/FX3 table. No download required.</span>';
  } else {
      const downloadLinks = urlObjects.map(u => `<a href="${u.url}" target="_blank" class="inline-block bg-orange-500 hover:bg-orange-600 text-white font-bold text-xs px-3 py-1 rounded-md transition-colors">${buttonText}</a>`).join("");
      urlsHtml = downloadLinks || '<span class="text-xs text-gray-500">No links available.</span>';
  }
  
  let iScoredButtonHtml = '';
  let tournamentButtonHtml = '';
  if (!isFocusedView && label === 'Visual Pinball Table' && gameId && file.id) {
    const iScoredUrl = `https://virtualpinballspreadsheet.github.io/?game=${gameId}&fileType=table#${file.id}`;
    iScoredButtonHtml = `<button onclick="copyToClipboard('${iScoredUrl}', this)" class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-bold text-xs px-3 py-1 rounded-md transition-colors disabled:opacity-50">iScored VPinStudio Tag</button>`;
    
    const tournamentUrl = `?tableId=${gameId}&releaseId=${file.id}`;
    tournamentButtonHtml = `<a href="${tournamentUrl}" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold text-xs px-3 py-1 rounded-md transition-colors">Tournament View</a>`;
  }

  const authors = (file.authors || []).join(", ") || "Unknown";
  const features = (file.features || []).join(", ") || "N/A";
  const comment = file.comment ? `<p class="text-sm mt-3 p-3 bg-gray-100 rounded-lg"><em>${file.comment}</em></p>` : "";

  const textContentHtml = `
    <div class="flex-grow">
      <h3 class="text-lg font-semibold">${label} <span class="text-base font-normal text-gray-500">${file.version ? `v${file.version}` : ''}</span></h3>
      <p class="text-sm text-gray-700 mt-1"><strong>Authors:</strong> ${authors}</p>
      <p class="text-sm text-gray-700"><strong>Features:</strong> ${features}</p>
      <div class="mt-3 pt-3 border-t border-gray-200 flex flex-wrap gap-2 items-center">
        ${urlsHtml}
        ${iScoredButtonHtml}
        ${tournamentButtonHtml}
      </div>
      ${comment}
    </div>`;
  return `<div class="bg-gray-50 rounded-xl p-4 flex flex-col sm:flex-row gap-4 items-start">${imageHtml}${textContentHtml}</div>`;
}

function closeModal() {
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

resultsContainer.addEventListener("click", (e) => {
  const card = e.target.closest('a[data-id]');
  if (card) { e.preventDefault(); openModal(card.dataset.id); }
});

let debounceTimer;
searchInput.addEventListener("input", e => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    const query = e.target.value.toLowerCase().trim();
    const filtered = db.filter(item =>
      item.name.toLowerCase().includes(query) ||
      (item.manufacturer || "").toLowerCase().includes(query) ||
      (item.tableFiles || []).some(file => (file.authors || []).some(author => author.toLowerCase().includes(query))) ||
      (item.theme || []).some(t => t.toLowerCase().includes(query))
    );
    renderResults(filtered);
  }, 250);
});

closeModalBtn.addEventListener("click", closeModal);
modal.addEventListener("click", (e) => { if (e.target === modal) { closeModal(); } });
window.addEventListener("keydown", (e) => { if (e.key === "Escape" && !modal.classList.contains("hidden")) { closeModal(); } });
</script>
</body>
</html>
